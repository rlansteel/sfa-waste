<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visor de Datos de Gestión de Residuos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src='https://cdn.plot.ly/plotly-2.32.0.min.js'></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #loading-map, #loading-list, #loading-boxplot, #loading-scatter-gdp, #loading-quality-hist, #no-results { 
            text-align: center; padding: 2rem; font-size: 1.2rem; color: #555; 
        }
        #entity-list a { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; } 
        #entity-list a:hover { background-color: #e0f2fe; color: #0c4a6e; } 
        .list-item { display: flex; justify-content: space-between; align-items: center; } 
        .quality-score { 
            font-size: 0.8rem; padding: 0.1rem 0.4rem; border-radius: 0.25rem; 
            background-color: #e5e7eb; color: #4b5563; border: 1px solid #d1d5db; margin-left: 0.5rem;
        }
        .score-high { background-color: #d1fae5; color: #065f46; border-color: #6ee7b7;} 
        .score-medium { background-color: #fef3c7; color: #92400e; border-color: #fcd34d;} 
        .score-low { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5;} 

        .filter-container { 
            display: flex; flex-wrap: wrap; gap: 1rem; 
            padding: 1.25rem; 
            background-color: #f9fafb; 
            border-radius: 0.5rem; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.03); 
        }
        .filter-group { display: flex; flex-direction: column; min-width: 180px; flex-grow: 1; } 
        .filter-group label { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.375rem; } 
        .filter-group input, .filter-group select { 
            padding: 0.625rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            font-size: 0.875rem; 
            background-color: #fff; 
        }
        .filter-group input:focus, .filter-group select:focus { 
            outline: none; 
            border-color: #2563eb; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); 
        }

        #map {
            height: 500px; 
            width: 100%; 
            border-radius: 0.5rem; 
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 0; 
        }
        .leaflet-popup-content-wrapper { border-radius: 0.375rem; }
        .leaflet-popup-content { font-size: 0.875rem; line-height: 1.4; }
        .leaflet-popup-content a { color: #2563eb; text-decoration: none; font-weight: 500; }
        .leaflet-popup-content a:hover { text-decoration: underline; }
        
        .chart-section { 
            padding-top: 1.5rem; 
            margin-top: 2rem; 
            border-top: 1px solid #e5e7eb; 
        }
        .chart-container-plotly { 
            width: 100%;
            min-height: 450px; 
            margin-top: 1rem; 
            background-color: #fff; 
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        }
        .no-chart-data { 
            text-align: center; color: #6b7280; 
            margin-top: 1rem; font-style: italic;
        }
        .status-extrapolated_by_sfa5 { color: #7c3aed; border-color: #a78bfa; background-color: #ede9fe; }

        .view-toggle-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .view-toggle-button.active {
            background-color: #0284c7; 
            color: white;
            border-color: #0369a1; 
        }
        .view-toggle-button.inactive {
            background-color: #e5e7eb; 
            color: #374151; 
            border-color: #d1d5db; 
        }
        .view-toggle-button.inactive:hover {
            background-color: #d1d5db; 
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-sky-700">Visor de Datos de Gestión de Residuos</h1>
            <p class="text-center text-gray-600 mt-2">Explora datos por país a través del mapa, gráficos o la lista.</p>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-xl">
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Filtros y Búsqueda</h2>
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="search-input">Buscar por Nombre o ISO:</label>
                        <input type="text" id="search-input" placeholder="Ej: Mexico, MEX...">
                    </div>
                    <div class="filter-group">
                        <label for="region-select">Filtrar por Región:</label>
                        <select id="region-select">
                            <option value="">Todas las Regiones</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="income-select">Filtrar por Ingresos:</label>
                        <select id="income-select">
                            <option value="">Todos los Grupos</option>
                        </select>
                    </div>
                     <div class="filter-group">
                        <label for="sort-select">Ordenar Por:</label>
                        <select id="sort-select">
                            <option value="name_asc">Nombre (A-Z)</option>
                            <option value="quality_desc">Mejor Calidad Primero</option>
                            <option value="quality_asc">Peor Calidad Primero</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="map-color-select">Colorear Mapa Por:</label>
                        <select id="map-color-select">
                            <option value="quality" selected>Calidad de Datos</option>
                            <option value="region">Región</option>
                            <option value="income">Grupo de Ingresos</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Mapa Interactivo</h2>
                <div id="loading-map">Cargando mapa y datos geográficos...</div>
                <div id="map"></div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <section class="chart-section border-t-0 mt-0 pt-0">
                     <h2 class="text-xl font-semibold mb-2 text-gray-700">Residuos Per Cápita por Nivel de Ingresos</h2>
                     <div id="loading-boxplot">Cargando gráfico...</div>
                     <div id="boxplot-container" class="chart-container-plotly">
                        <p id="no-boxplot-data" class="no-chart-data" style="display: none;">Datos insuficientes para generar el boxplot.</p>
                     </div>
                </section>

                <section class="chart-section border-t-0 mt-0 pt-0 lg:border-t lg:mt-2 lg:pt-1.5rem">
                    <h2 class="text-xl font-semibold mb-2 text-gray-700">Residuos Per Cápita vs. PIB Per Cápita</h2>
                    <p class="text-xs text-gray-500 mb-1">El tamaño de la burbuja representa la población total del país.</p>
                    <div id="loading-scatter-gdp">Cargando gráfico...</div>
                    <div id="scatter-gdp-container" class="chart-container-plotly">
                        <p id="no-scatter-gdp-data" class="no-chart-data" style="display: none;">Datos insuficientes para generar el gráfico de dispersión.</p>
                    </div>
                </section>

                <section class="chart-section lg:col-span-2 border-t-0 mt-0 pt-0 lg:border-t lg:mt-2 lg:pt-1.5rem">
                    <h2 class="text-xl font-semibold mb-2 text-gray-700">Distribución de Puntajes de Calidad</h2>
                    <div id="loading-quality-hist">Cargando gráfico...</div>
                    <div id="quality-hist-container" class="chart-container-plotly">
                         <p id="no-quality-hist-data" class="no-chart-data" style="display: none;">Datos insuficientes para generar el histograma de calidad.</p>
                    </div>
                </section>
            </div>
            
            <section>
                <div class="flex justify-between items-center mb-4 border-t pt-6">
                    <h2 id="entity-list-title" class="text-2xl font-semibold text-gray-700">Lista de Países</h2>
                    <div class="flex space-x-2">
                        <button id="view-countries-btn" class="view-toggle-button active">Países</button>
                        <button id="view-cities-btn" class="view-toggle-button inactive">Ciudades</button>
                    </div>
                </div>
                <div id="loading-list">Cargando lista...</div>
                <div id="no-results" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md">No se encontraron resultados con los filtros aplicados.</div>
                <ul id="entity-list" class="space-y-2"></ul>
            </section>
        </main>

        <footer class="text-center text-gray-500 mt-12 text-sm">
            Datos procesados el <span id="current-date"></span>.
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Comentario: DOM completamente cargado y analizado.

            // --- Elementos del DOM ---
            const entityListElement = document.getElementById('entity-list');
            const loadingMapElement = document.getElementById('loading-map');
            const loadingListElement = document.getElementById('loading-list');
            const loadingBoxplotElement = document.getElementById('loading-boxplot');
            const loadingScatterGdpElement = document.getElementById('loading-scatter-gdp'); 
            const loadingQualityHistElement = document.getElementById('loading-quality-hist'); 
            const noResultsElement = document.getElementById('no-results');
            const dateElement = document.getElementById('current-date');
            const searchInput = document.getElementById('search-input');
            const regionSelect = document.getElementById('region-select');
            const incomeSelect = document.getElementById('income-select');
            const sortSelect = document.getElementById('sort-select'); 
            const mapColorSelect = document.getElementById('map-color-select'); 
            const mapElement = document.getElementById('map');
            const boxplotContainer = document.getElementById('boxplot-container');
            const scatterGdpContainer = document.getElementById('scatter-gdp-container'); 
            const qualityHistContainer = document.getElementById('quality-hist-container'); 
            const viewCountriesBtn = document.getElementById('view-countries-btn'); 
            const viewCitiesBtn = document.getElementById('view-cities-btn');     
            const entityListTitle = document.getElementById('entity-list-title'); 


            // --- Variables Globales ---
            let wasteDataCountries = []; 
            let allCitiesFlatList = [];  
            let geoJsonCountriesLayer = null;
            let cityMarkersLayer = null;
            let map = null;
            let countryGeoJsonData = null;
            let selectedCountryLayer = null;
            let currentListView = 'countries'; 

            const GEOJSON_ISO_PROPERTY = 'ISO3166-1-Alpha-3'; 
            const UI_DATA_DIR = './output/ui_data/'; 

            // Paletas de colores para el mapa
            const REGION_COLORS = { 
                'East Asia & Pacific': '#a6cee3',
                'EAP': '#a6cee3', 
                'Europe & Central Asia': '#1f78b4',
                'ECA': '#1f78b4',
                'Latin America & Caribbean': '#b2df8a',
                'LAC': '#b2df8a', 
                'Middle East & North Africa': '#33a02c',
                'MENA': '#33a02c',
                'North America': '#fb9a99',
                'NA': '#fb9a99', 
                'South Asia': '#e31a1c',
                'SA': '#e31a1c',
                'Sub-Saharan Africa': '#fdbf6f',
                'SSA': '#fdbf6f', 
                'Default': '#D1D5DB' // Tailwind gray-300
            };

            const INCOME_GROUP_COLORS = { 
                'High income': '#1b9e77',
                'HIC': '#1b9e77', 
                'Upper middle income': '#d95f02',
                'UMC': '#d95f02', 
                'Lower middle income': '#7570b3',
                'LMC': '#7570b3', 
                'Low income': '#e7298a',
                'LIC': '#e7298a', 
                'Default': '#9CA3AF' // Tailwind gray-400
            };


            dateElement.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            // --- Inicialización del Mapa ---
            function initMap() {
                // Comentario: Intenta inicializar el mapa Leaflet.
                if (mapElement && !map) {
                    try {
                        map = L.map('map').setView([20, 0], 2); 
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 18, 
                            minZoom: 2   
                        }).addTo(map);
                        cityMarkersLayer = L.layerGroup().addTo(map); 
                        // Comentario: Mapa y capa de marcadores de ciudades inicializados.
                    } catch (e) { 
                        console.error("Error inicializando Leaflet:", e);
                        mapElement.innerHTML = "<p class='text-red-500 text-center'>Error al cargar el mapa.</p>";
                        if(loadingMapElement) loadingMapElement.style.display = 'none';
                     }
                }
            }

            // --- Funciones Auxiliares ---
            function populateSelect(selectElement, options) {
                // Comentario: Rellena un elemento <select> con opciones.
                const firstOption = selectElement.options[0]; 
                selectElement.innerHTML = ''; 
                selectElement.appendChild(firstOption); 
                if (options && Array.isArray(options)) {
                    options.sort((a, b) => String(a).localeCompare(String(b))); 
                    options.forEach(optionValue => {
                        if (optionValue) { 
                            const option = document.createElement('option');
                            option.value = optionValue;
                            option.textContent = optionValue;
                            selectElement.appendChild(option);
                        }
                    });
                }
            }

            function displayCityMarkers(countryIso3) {
                // Comentario: Muestra marcadores para las ciudades de un país específico.
                if (!map || !cityMarkersLayer) { return; }
                cityMarkersLayer.clearLayers(); 
                const countryData = wasteDataCountries.find(c => c.iso3 === countryIso3);
                if (countryData?.cities?.length > 0) {
                    let citiesWithCoords = 0;
                    const cityBounds = L.latLngBounds(); 
                    countryData.cities.forEach(city => {
                        const lat = parseFloat(city.latitude);
                        const lon = parseFloat(city.longitude);
                        if (!isNaN(lat) && !isNaN(lon) && city.latitude_geo_status === 'found' && city.longitude_geo_status === 'found') {
                            citiesWithCoords++;
                            const cityMarker = L.marker([lat, lon]);
                            let cityPopupContent = `<strong>${city.name}</strong>`;
                            cityPopupContent += `<br><a href="city_view.html?id=${city.id}&iso3=${countryIso3}" class="text-sky-600 hover:underline">Ver detalles &rarr;</a>`;
                            cityMarker.bindPopup(cityPopupContent);
                            cityMarkersLayer.addLayer(cityMarker);
                            cityBounds.extend([lat, lon]); 
                        }
                    });
                    if (citiesWithCoords > 0) { 
                         try {
                           if (selectedCountryLayer) { 
                                map.fitBounds(selectedCountryLayer.getBounds().extend(cityBounds), {padding: [50,50], maxZoom: 10});
                           } else { 
                                map.fitBounds(cityBounds, {padding: [50,50], maxZoom: 10});
                           }
                         } catch (e) { console.warn("No se pudo hacer zoom a las ciudades:", e); }
                    }
                }
            }
            
            function styleCountry(feature) {
                // Comentario: Define el estilo de los polígonos de países en el mapa.
                const isoA3 = feature.properties[GEOJSON_ISO_PROPERTY];
                const countryData = wasteDataCountries.find(c => c.iso3 === isoA3);
                let fillColor = '#D1D5DB'; 
                let fillOpacity = 0.4;
                const colorBy = mapColorSelect.value; 

                if (countryData) { 
                    fillOpacity = 0.65; 
                    switch (colorBy) {
                        case 'quality':
                            if (countryData.data_quality_score !== null && countryData.data_quality_score !== undefined) {
                                const score = parseFloat(countryData.data_quality_score);
                                if (score >= 75) fillColor = '#10B981'; 
                                else if (score >= 50) fillColor = '#F59E0B'; 
                                else fillColor = '#EF4444'; 
                            } else {
                                fillColor = '#6B7280'; 
                            }
                            break;
                        case 'region':
                            const regionValue = countryData.region ? String(countryData.region).trim() : 'Default';
                            
                            // Intenta encontrar el color para múltiples formatos posibles
                            if (REGION_COLORS[regionValue]) {
                                fillColor = REGION_COLORS[regionValue];
                            } else {
                                // Si no encuentra coincidencia exacta, busca una coincidencia parcial
                                const regionKey = Object.keys(REGION_COLORS).find(key => 
                                    regionValue.includes(key) || key.includes(regionValue)
                                );
                                fillColor = regionKey ? REGION_COLORS[regionKey] : REGION_COLORS['Default'];
                            }
                            break;
                        case 'income':
                            const incomeValue = countryData.income ? String(countryData.income).trim() : 'Default';
                            
                            // Intenta encontrar el color para múltiples formatos posibles
                            if (INCOME_GROUP_COLORS[incomeValue]) {
                                fillColor = INCOME_GROUP_COLORS[incomeValue];
                            } else {
                                // Si no encuentra coincidencia exacta, busca una coincidencia parcial
                                const incomeKey = Object.keys(INCOME_GROUP_COLORS).find(key => 
                                    incomeValue.includes(key) || key.includes(incomeValue)
                                );
                                fillColor = incomeKey ? INCOME_GROUP_COLORS[incomeKey] : INCOME_GROUP_COLORS['Default'];
                            }
                            break;
                        default:
                            fillColor = '#3b82f6'; 
                    }
                }
                return { fillColor: fillColor, weight: 1, opacity: 1, color: 'white', fillOpacity: fillOpacity };
            }

            function highlightFeature(e) {
                // Comentario: Resalta un país al pasar el cursor sobre él.
                const layer = e.target;
                if (layer !== selectedCountryLayer) { 
                    layer.setStyle({ weight: 2.5, color: '#4b5563', dashArray: '', fillOpacity: layer.options.fillOpacity + 0.15 });
                }
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
                 if (selectedCountryLayer && selectedCountryLayer !== layer) { selectedCountryLayer.bringToFront(); }
            }

            function resetHighlight(e) {
                // Comentario: Quita el resaltado de un país cuando el cursor sale.
                if (e.target !== selectedCountryLayer) { 
                    if (geoJsonCountriesLayer) geoJsonCountriesLayer.resetStyle(e.target);
                }
            }

            function onCountryClick(e) {
                // Comentario: Maneja el clic en un país del mapa.
                const layer = e.target;
                const isoA3 = layer.feature.properties[GEOJSON_ISO_PROPERTY];
                
                if (selectedCountryLayer && selectedCountryLayer !== layer) { 
                    if (geoJsonCountriesLayer) geoJsonCountriesLayer.resetStyle(selectedCountryLayer);
                }
                
                layer.setStyle({ fillColor: '#1d4ed8', fillOpacity: 0.85, weight: 2.5, color: '#333' }); 
                selectedCountryLayer = layer;
                layer.bringToFront();
                displayCityMarkers(isoA3); 
            }

            function onEachFeature(feature, layer) {
                // Comentario: Se ejecuta para cada feature (país) en la capa GeoJSON.
                if (!feature.properties) { return; }
                const isoA3 = feature.properties[GEOJSON_ISO_PROPERTY];
                const countryNameGeo = feature.properties.ADMIN || feature.properties.NAME || feature.properties.name || 'País Desconocido';
                if (!isoA3) { layer.bindPopup(`<strong>${countryNameGeo}</strong><br>(ISO no encontrado en GeoJSON)`); return; }

                const countryData = wasteDataCountries.find(c => c.iso3 === isoA3);
                let popupContent = `<strong>${countryData?.country_name || countryNameGeo} (${isoA3})</strong>`;
                if (countryData) {
                    popupContent += `<br><a href="country_view.html?iso3=${isoA3}" class="text-sky-600 hover:underline">Ver detalles del país &rarr;</a>`;
                    if (countryData.cities?.length > 0) {
                        popupContent += `<br><hr class="my-1 border-gray-300"><em>${countryData.cities.length} ciudad(es) con datos. Haz clic en el país en el mapa para ver marcadores.</em>`;
                    }
                } else {
                    popupContent += `<br><span class="text-gray-500">(Datos de gestión no disponibles en el índice)</span>`;
                }
                layer.bindPopup(popupContent);
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: onCountryClick });
            }

             function getQualityScoreClass(score) {
                // Comentario: Devuelve la clase CSS para el puntaje de calidad.
                if (score === null || score === undefined || isNaN(parseFloat(score))) return '';
                const numericScore = parseFloat(score);
                if (numericScore >= 75) return 'score-high';
                if (numericScore >= 50) return 'score-medium';
                return 'score-low';
            }
            
            function updateDisplayedEntities(entitiesToDisplay) {
                // Comentario: Actualiza la lista de entidades (países o ciudades) mostrada.
                entityListElement.innerHTML = ''; 
                if (entitiesToDisplay.length > 0) {
                    noResultsElement.classList.add('hidden');
                    entitiesToDisplay.forEach(entity => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-item p-3 bg-gray-50 hover:bg-sky-50 rounded-md border border-gray-200';
                        const link = document.createElement('a');
                        link.className = 'text-sky-700 hover:text-sky-900 font-medium flex-grow';

                        if (currentListView === 'countries') {
                            link.href = `country_view.html?iso3=${entity.iso3}`;
                            link.textContent = `${entity.country_name} (${entity.iso3})`;
                        } else { 
                            link.href = `city_view.html?id=${entity.id}&iso3=${entity.country_iso3}`;
                            link.textContent = `${entity.name} (${entity.country_name}, ${entity.country_iso3})`;
                        }
                        listItem.appendChild(link);

                        if (entity.data_quality_score !== null && entity.data_quality_score !== undefined) {
                            const scoreSpan = document.createElement('span');
                            scoreSpan.textContent = `Calidad: ${parseFloat(entity.data_quality_score).toFixed(1)}`;
                            scoreSpan.className = `quality-score ${getQualityScoreClass(entity.data_quality_score)}`;
                            listItem.appendChild(scoreSpan);
                        }
                        entityListElement.appendChild(listItem);
                    });
                } else {
                    noResultsElement.classList.remove('hidden'); 
                }
                if (loadingListElement) loadingListElement.style.display = 'none';
            }
            
            function applyFilters() {
                // Comentario: Aplica todos los filtros y actualiza la visualización.
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedRegion = regionSelect.value;
                const selectedIncome = incomeSelect.value;
                const sortValue = sortSelect.value;

                let entitiesToDisplay = [];

                if (currentListView === 'countries') {
                    if(entityListTitle) entityListTitle.textContent = "Lista de Países";
                    let filteredCountries = wasteDataCountries.filter(country => {
                        const nameMatch = country.country_name.toLowerCase().includes(searchTerm);
                        const isoMatch = country.iso3.toLowerCase().includes(searchTerm);
                        const regionMatch = !selectedRegion || country.region === selectedRegion;
                        const incomeMatch = !selectedIncome || country.income === selectedIncome;
                        return (nameMatch || isoMatch) && regionMatch && incomeMatch;
                    });

                    if (sortValue === 'quality_desc') {
                        filteredCountries.sort((a, b) => (b.data_quality_score ?? -1) - (a.data_quality_score ?? -1));
                    } else if (sortValue === 'quality_asc') {
                        filteredCountries.sort((a, b) => (a.data_quality_score ?? Infinity) - (b.data_quality_score ?? Infinity));
                    } else { 
                        filteredCountries.sort((a, b) => (a.country_name || "").localeCompare(b.country_name || ""));
                    }
                    entitiesToDisplay = filteredCountries;

                } else { 
                    if(entityListTitle) entityListTitle.textContent = "Lista de Ciudades";
                    let filteredCities = [];
                    allCitiesFlatList.forEach(city => { 
                        const countryOfCity = wasteDataCountries.find(c => c.iso3 === city.country_iso3);
                        if (countryOfCity) { 
                            const regionMatch = !selectedRegion || countryOfCity.region === selectedRegion;
                            const incomeMatch = !selectedIncome || countryOfCity.income === selectedIncome;
                            const nameMatch = city.name.toLowerCase().includes(searchTerm) || 
                                              city.country_name.toLowerCase().includes(searchTerm) || 
                                              city.country_iso3.toLowerCase().includes(searchTerm);

                            if (nameMatch && regionMatch && incomeMatch) {
                                filteredCities.push(city);
                            }
                        }
                    });

                    if (sortValue === 'quality_desc') {
                        filteredCities.sort((a, b) => (b.data_quality_score ?? -1) - (a.data_quality_score ?? -1));
                    } else if (sortValue === 'quality_asc') {
                        filteredCities.sort((a, b) => (a.data_quality_score ?? Infinity) - (b.data_quality_score ?? Infinity));
                    } else { 
                        filteredCities.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                    }
                    entitiesToDisplay = filteredCities;
                }
                updateDisplayedEntities(entitiesToDisplay);
                
                if (geoJsonCountriesLayer && map) { map.removeLayer(geoJsonCountriesLayer); geoJsonCountriesLayer = null; }
                if (countryGeoJsonData && map) {
                    const countriesMatchingFilters = wasteDataCountries.filter(country => {
                         const regionMatch = !selectedRegion || country.region === selectedRegion;
                         const incomeMatch = !selectedIncome || country.income === selectedIncome;
                         let searchOverallMatch = true;
                         if(searchTerm){
                            searchOverallMatch = country.country_name.toLowerCase().includes(searchTerm) || country.iso3.toLowerCase().includes(searchTerm);
                            if(!searchOverallMatch && country.cities && country.cities.length > 0){
                                searchOverallMatch = country.cities.some(city => city.name.toLowerCase().includes(searchTerm));
                            }
                         }
                         return searchOverallMatch && regionMatch && incomeMatch;
                    });
                    const iso3InFilteredData = new Set(countriesMatchingFilters.map(c => c.iso3));

                    const filteredGeoJsonFeatures = {
                        type: "FeatureCollection",
                        features: countryGeoJsonData.features.filter(feature =>
                            feature.properties && iso3InFilteredData.has(feature.properties[GEOJSON_ISO_PROPERTY])
                        )
                    };
                     if (filteredGeoJsonFeatures.features.length > 0) {
                        geoJsonCountriesLayer = L.geoJSON(filteredGeoJsonFeatures, { style: styleCountry, onEachFeature: onEachFeature }).addTo(map);
                    }
                }
                if (cityMarkersLayer) cityMarkersLayer.clearLayers(); 
                selectedCountryLayer = null; 
            }


            // --- Funciones para crear gráficos Plotly ---
            function createPlotlyChart(containerId, data, layout, loadingElementId, noDataElementId) {
                const chartContainer = document.getElementById(containerId);
                const loadingEl = document.getElementById(loadingElementId);
                const noDataEl = document.getElementById(noDataElementId);

                if (loadingEl) loadingEl.style.display = 'none';
                
                let hasPlottableData = false;
                if (Array.isArray(data) && data.length > 0) {
                    hasPlottableData = data.some(trace => 
                        (trace.x && trace.x.length > 0) || 
                        (trace.y && trace.y.length > 0) ||
                        (trace.values && trace.values.length > 0) 
                    );
                }

                if (!hasPlottableData) {
                    if (noDataEl) noDataEl.style.display = 'block';
                    if (chartContainer) chartContainer.style.display = 'none';
                    return;
                }

                if (noDataEl) noDataEl.style.display = 'none';
                if (chartContainer) chartContainer.style.display = 'block';
                
                Plotly.newPlot(containerId, data, layout, {responsive: true, displaylogo: false});
            }
            
            function createWastePerCapitaBoxplot(countriesData) {
                // Comentario: Crea el gráfico boxplot de residuos per cápita.
                const relevantData = countriesData.filter(c =>
                    c.income && c.waste_per_capita_kg_day !== null && !isNaN(parseFloat(c.waste_per_capita_kg_day))
                );
                const dataByIncome = {};
                const incomeOrder = ['LIC', 'LMC', 'UMC', 'HIC'];
                incomeOrder.forEach(incomeGroup => { dataByIncome[incomeGroup] = []; });
                relevantData.forEach(country => {
                    if (dataByIncome[country.income]) {
                        dataByIncome[country.income].push(parseFloat(country.waste_per_capita_kg_day));
                    }
                });
                const traces = incomeOrder.map(incomeGroup => ({
                    y: dataByIncome[incomeGroup], type: 'box', name: incomeGroup,
                    boxpoints: 'all', jitter: 0.3, pointpos: -1.8,
                    marker: { color: incomeGroup === 'LIC' ? '#EF4444' : incomeGroup === 'LMC' ? '#F59E0B' : incomeGroup === 'UMC' ? '#EAB308' : '#10B981' }
                })).filter(trace => trace.y && trace.y.length > 0); 
                const layout = {
                    title: { text: null }, 
                    yaxis: { title: 'kg / persona / día', zeroline: false, automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    xaxis: { title: 'Nivel de Ingresos (BM)', categoryorder: 'array', categoryarray: incomeOrder, automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    margin: { l: 50, r: 20, b: 70, t: 20 }, showlegend: false, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                };
                createPlotlyChart('boxplot-container', traces, layout, 'loading-boxplot', 'no-boxplot-data');
            }

            function createWpcVsGdpScatterPlot(countriesData) {
                // Comentario: Crea el gráfico de dispersión WPC vs GDP, con tamaño de burbuja por población.
                const plotData = countriesData.filter(c =>
                    c.gdp_per_capita_usd !== null && !isNaN(parseFloat(c.gdp_per_capita_usd)) &&
                    c.waste_per_capita_kg_day !== null && !isNaN(parseFloat(c.waste_per_capita_kg_day)) &&
                    c.income &&
                    c.population_total !== null && !isNaN(parseFloat(c.population_total)) && parseFloat(c.population_total) > 0 
                );
                
                const loadingElScatter = document.getElementById('loading-scatter-gdp');
                const noDataElScatter = document.getElementById('no-scatter-gdp-data');
                const containerElScatter = document.getElementById('scatter-gdp-container');

                if (!plotData || plotData.length === 0) { 
                     if(loadingElScatter) loadingElScatter.style.display = 'none';
                     if(noDataElScatter) noDataElScatter.style.display = 'block';
                     if(containerElScatter) containerElScatter.style.display = 'none';
                     return;
                }
                if(noDataElScatter) noDataElScatter.style.display = 'none';
                if(containerElScatter) containerElScatter.style.display = 'block';

                const incomeGroups = [...new Set(plotData.map(item => item.income))].sort();
                
                // Definir colores para cada grupo de ingresos
                const incomeColors = {
                    'High income': '#1b9e77',
                    'HIC': '#1b9e77',
                    'Upper middle income': '#d95f02',
                    'UMC': '#d95f02',
                    'Lower middle income': '#7570b3',
                    'LMC': '#7570b3',
                    'Low income': '#e7298a',
                    'LIC': '#e7298a',
                    'Default': '#9CA3AF'
                };
                
                const traces = incomeGroups.map(group => {
                    const groupData = plotData.filter(c => c.income === group);
                    if (groupData.length === 0) return null; 

                    const populations = groupData.map(c => parseFloat(c.population_total));
                    const validPopulations = populations.filter(p => p > 0 && !isNaN(p)); 

                    let scaledSizes;
                    const baseSize = 5; 
                    const maxSize = 40; 

                    if (validPopulations.length > 0) {
                        const logPopulations = validPopulations.map(p => Math.log10(p));
                        const minPopLog = Math.min(...logPopulations); 
                        const maxPopLog = Math.max(...logPopulations);
                        
                        if (minPopLog === maxPopLog) { 
                            scaledSizes = populations.map(() => (baseSize + maxSize) / 2);
                        } else {
                            scaledSizes = populations.map(pop => {
                                 if (pop <=0 || isNaN(pop)) return baseSize; 
                                 const logPop = Math.log10(pop);
                                 // Normalizar logPop entre 0 y 1
                                 const normalizedLogPop = (maxPopLog === minPopLog) ? 0.5 : (logPop - minPopLog) / (maxPopLog - minPopLog);
                                 const scaled = baseSize + (maxSize - baseSize) * normalizedLogPop;
                                 return Math.max(baseSize, Math.min(maxSize, scaled)); 
                            });
                        }
                    } else { 
                        scaledSizes = populations.map(() => baseSize);
                    }

                    return {
                        x: groupData.map(c => parseFloat(c.gdp_per_capita_usd)),
                        y: groupData.map(c => parseFloat(c.waste_per_capita_kg_day)),
                        text: groupData.map(c => 
                            `${c.country_name} (${c.iso3})<br>` +
                            `PIB: ${parseFloat(c.gdp_per_capita_usd).toLocaleString('es-ES', {style:'currency', currency:'USD', minimumFractionDigits:0})}<br>` +
                            `Residuos: ${parseFloat(c.waste_per_capita_kg_day).toFixed(2)} kg/día<br>` +
                            `Población: ${parseFloat(c.population_total).toLocaleString('es-ES')}`
                        ), 
                        mode: 'markers', 
                        type: 'scatter', 
                        name: group, 
                        marker: { 
                            size: scaledSizes, 
                            color: incomeColors[group] || incomeColors['Default'],  // Asignar color según el grupo
                            opacity: 0.7,
                            line: { width: 0.5, color: 'rgba(0,0,0,0.5)'}
                        }
                    };
                }).filter(trace => trace && trace.x && trace.x.length > 0 && trace.y && trace.y.length > 0); 
                
                const layout = {
                    title: { text: null },
                    xaxis: { title: 'PIB Per Cápita (USD, Escala Log)', type: 'log', automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    yaxis: { title: 'Residuos Per Cápita (kg/día)', automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    hovermode: 'closest',
                    legend: { title: { text: 'Nivel Ingresos'}, font: {size: 10} },
                    margin: { l: 50, r: 20, b: 70, t: 20 },
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                };
                createPlotlyChart('scatter-gdp-container', traces, layout, 'loading-scatter-gdp', 'no-scatter-gdp-data');
            }

            function createQualityScoreHistogram(countriesData) {
                // Comentario: Crea el histograma de puntajes de calidad.
                const qualityScores = countriesData.map(c => parseFloat(c.data_quality_score)).filter(score => !isNaN(score));
                const trace = {
                    x: qualityScores, type: 'histogram',
                    marker: { color: '#3b82f6' }, 
                    xbins: { size: 10 } 
                };
                const layout = {
                    title: { text: null },
                    xaxis: { title: 'Puntaje de Calidad (0-100)', automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    yaxis: { title: 'Número de Países', automargin: true, titlefont: {size: 12}, tickfont: {size: 10} },
                    bargap: 0.1,
                    margin: { l: 50, r: 20, b: 70, t: 20 },
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                };
                createPlotlyChart('quality-hist-container', [trace], layout, 'loading-quality-hist', 'no-quality-hist-data');
            }

            // --- Event Listeners ---
            searchInput.addEventListener('input', applyFilters);
            regionSelect.addEventListener('change', applyFilters);
            incomeSelect.addEventListener('change', applyFilters);
            sortSelect.addEventListener('change', applyFilters);
            mapColorSelect.addEventListener('change', applyFilters); 

            viewCountriesBtn.addEventListener('click', () => {
                if (currentListView !== 'countries') {
                    currentListView = 'countries';
                    viewCountriesBtn.classList.replace('inactive', 'active');
                    viewCitiesBtn.classList.replace('active', 'inactive');
                    applyFilters();
                }
            });

            viewCitiesBtn.addEventListener('click', () => {
                if (currentListView !== 'cities') {
                    currentListView = 'cities';
                    viewCitiesBtn.classList.replace('inactive', 'active');
                    viewCountriesBtn.classList.replace('active', 'inactive');
                    applyFilters();
                }
            });

            // --- Carga de Datos Inicial ---
            initMap();
            Promise.all([
                fetch(`${UI_DATA_DIR}countries_polygons.geojson`) 
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status} cargando GeoJSON desde ${UI_DATA_DIR}countries_polygons.geojson`);
                        return response.json();
                    }),
                fetch(`${UI_DATA_DIR}index.json`) 
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status} cargando index.json desde ${UI_DATA_DIR}`);
                        return response.json();
                    })
            ])
            .then(([geoData, wasteData]) => {
                countryGeoJsonData = geoData;
                wasteDataCountries = wasteData.countries; 

                allCitiesFlatList = [];
                wasteDataCountries.forEach(country => {
                    if (country.cities && Array.isArray(country.cities)) {
                        country.cities.forEach(city => {
                            allCitiesFlatList.push({
                                ...city, 
                                country_iso3: country.iso3, 
                                country_name: country.country_name,
                                region: country.region, 
                                income: country.income  
                            });
                        });
                    }
                });
                
                populateSelect(regionSelect, wasteData.regions);
                populateSelect(incomeSelect, wasteData.income_groups);
                applyFilters(); 

                createWastePerCapitaBoxplot(wasteDataCountries);
                createWpcVsGdpScatterPlot(wasteDataCountries); 
                createQualityScoreHistogram(wasteDataCountries);

                if (loadingMapElement) loadingMapElement.style.display = 'none';
                // Comentario: Configuración inicial completada.
            })
            .catch(error => { 
                if (loadingMapElement) loadingMapElement.style.display = 'none';
                if (loadingListElement) loadingListElement.style.display = 'none';
                const errorElementsToHide = ['loading-boxplot', 'loading-scatter-gdp', 'loading-quality-hist'];
                errorElementsToHide.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });

                const mapContainer = document.getElementById('map');
                let errorMsg = `Error crítico al cargar datos: ${error.message}. Revisa la consola del navegador (F12) para ver qué archivo no se encontró (error 404) y verifica que las rutas a '${UI_DATA_DIR}countries_polygons.geojson' y '${UI_DATA_DIR}index.json' sean correctas.`;
                console.error('Error en Promise.all o procesamiento:', error);
                if (mapContainer) mapContainer.innerHTML = `<p class='text-red-500 p-4 text-center'>${errorMsg}</p>`;
                
                const chartErrorContainers = ['boxplot-container', 'scatter-gdp-container', 'quality-hist-container'];
                chartErrorContainers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = `<p class='no-chart-data'>Error al cargar datos para el gráfico.</p>`;
                });

                if (noResultsElement) {
                     noResultsElement.textContent = 'No se pudieron cargar los datos iniciales. Intenta recargar la página y revisa la consola del navegador.';
                     noResultsElement.classList.remove('hidden');
                     noResultsElement.style.color = 'red';
                }
            });
        });
    </script>
</body>
</html>